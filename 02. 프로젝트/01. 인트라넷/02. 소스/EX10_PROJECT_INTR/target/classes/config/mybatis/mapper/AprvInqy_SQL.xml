<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="aprvInqy">
	<resultMap type="HashMap" id="getAprvInfo">
		<result property="aprvIdx" column="APRV_IDX"/>
		<result property="aprvSno" column="APRV_SNO"/>
		<result property="aprvTitle" column="APRV_TITLE"/>
		<result property="templateCd" column="TEMPLATE_CD"/>
		<result property="regDt" column="REG_DT"/>
		<result property="regTm" column="REG_TM"/>
		<result property="stepCd" column="STEP_CD"/>
		<result property="stepNm" column="STEP_NM"/>
		<result property="aprvContent" column="APRV_CONTENT" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>

	<select id="intrAprvInqy10101010" resultType="CamelHashMap" parameterType="java.util.HashMap">
		/* intrAprvInqy10101010 : 결재내역 목록 조회 */
		SELECT 
		    	SUB_DATA.* 
		    	,   CASE WHEN SUB_DATA.FILE_CNT <![CDATA[>]]> 0
		            THEN 'Y'
		            ELSE 'N'
		            END AS FILE_YN
		FROM (
				SELECT 
				        APRV.APRV_IDX
				    ,	APRV.APRV_SNO
				    ,   APRV.EMP_IDX
                    ,	LINE.STEP_CD
				    ,	STEP.STEP_NM
				    ,	LINE.LAST_APRV_YN
                    ,   CASE WHEN LINE.LAST_APRV_YN = 'Y'
                            THEN STEP.STEP_NM || ' 완료'
                            ELSE STEP.STEP_NM || ' 진행 중' END AS CURR_STEP_NM
				    ,   EMP.EMP_NM
				    ,   DEPT.DEPT_NM
				    ,   APRV_TITLE
				    ,   APRV.REG_DT AS APRV_REG_DT
				    ,   APRV.REG_TM AS APRV_REG_TM
				    ,   RANK() OVER(ORDER BY APRV.APRV_IDX) AS NUM
				    ,   COUNT(APRV.APRV_IDX) OVER() AS LIST_CNT
				    ,   (SELECT 
				            COUNT(CONTENT_IDX)
				         FROM INTR_FILE
				         WHERE CONTENT_IDX = APRV.APRV_IDX
				            AND USE_YN = 'Y'
				        ) AS FILE_CNT
				FROM INTR_APRV APRV
                INNER JOIN INTR_APRV_LINE LINE
                    ON LINE.APRV_IDX = APRV.APRV_IDX
                    AND LINE.APRV_SNO = APRV.APRV_SNO
                LEFT OUTER JOIN INTR_STEP STEP
                    ON STEP.STEP_CD = LINE.STEP_CD
				LEFT OUTER JOIN INTR_EMP EMP
				    ON APRV.EMP_IDX = EMP.EMP_IDX
				LEFT OUTER JOIN INTR_DEPT DEPT
				    ON DEPT.DEPT_CD = EMP.DEPT_CD
				    AND DEPT.USE_YN = 'Y'
				WHERE 
					1=1
				    	AND APRV.USE_YN = 'Y'
				    <if test="srchNm != null and srchNm != ''">
		            	AND REGEXP_REPLACE(LOWER(APRV.APRV_TITLE),'[^0-9가-힣A-Za-z]*','') LIKE '%'||REGEXP_REPLACE(LOWER(#{srchNm, jdbcType=VARCHAR}),'[^0-9가-힣A-Za-z]*','')||'%'
		            </if>
		            <if test="srchSdt != null and srchSdt !=''">
		            	AND APRV.REG_DT &gt;= REPLACE(#{srchSdt, jdbcType=VARCHAR},'-','')
		            </if>
		            <if test="srchEdt != null and srchEdt !=''">
		            	AND APRV.REG_DT &lt;= REPLACE(#{srchEdt, jdbcType=VARCHAR},'-','')
		            </if>
			) SUB_DATA
		WHERE 
			1=1
			<if test="(sIdx != null and sIdx !='') and (eIdx != null and eIdx !='')">
 				AND SUB_DATA.NUM BETWEEN #{sIdx, jdbcType=VARCHAR} AND #{eIdx, jdbcType=VARCHAR}
        	</if>
		ORDER BY SUB_DATA.APRV_REG_DT DESC, SUB_DATA.APRV_REG_TM DESC
	</select>
	
	<select id="intrAprvInqy10102010" resultType="CamelHashMap" parameterType="java.util.HashMap" resultMap="getAprvInfo">
		/* intrAprvInqy10102010 : 결재내역 목록 조회 */
			SELECT 
			    	APRV.APRV_IDX
			    ,	APRV.APRV_SNO 
			    ,	APRV.APRV_TITLE 
			    ,	APRV.APRV_CONTENT 
			    ,	APRV.TEMPLATE_CD 
			    ,	APRV.REG_DT
			    ,	APRV.REG_TM
			    ,	LINE.STEP_CD
			    ,	STEP.STEP_NM
		FROM INTR_APRV APRV
		INNER JOIN INTR_APRV_LINE LINE
			ON LINE.APRV_IDX = APRV.APRV_IDX
			AND LINE.APRV_SNO = APRV.APRV_SNO
		LEFT OUTER JOIN INTR_STEP STEP
			ON STEP.STEP_CD = LINE.STEP_CD
		WHERE APRV.APRV_IDX = #{contentIdx, jdbcType=VARCHAR}
	</select>
	
	<select id="intrAprvInqy10103010" resultType="CamelHashMap" parameterType="java.util.HashMap" resultMap="getAprvInfo">
		/* intrAprvInqy10103010 : 결재선 목록 조회 */
		SELECT  
		        LINE.APRV_IDX
		    ,   LINE.APRV_SNO
		    ,   LINE.STEP_CD
		    ,   STEP.STEP_NM
		    ,   LINE.APRV_EMP_IDX
		    ,   EMP.EMP_NM
		    ,   EMP.DEPT_CD
		    ,   DEPT.DEPT_NM
		    ,   EMP.GRADE_CD
		    ,   GRDE.GRADE_NM
		    ,   LINE.APRV_RSLT_DT
		    ,   LINE.APRV_RSLT_TM
		    ,   LINE.APRV_RSLT_RESN
		    ,	LINE.USE_YN
		    ,	LINE.DISP_ORDER
		FROM INTR_APRV_LINE LINE
		LEFT OUTER JOIN INTR_STEP STEP
			ON LINE.STEP_CD = STEP.STEP_CD
		LEFT OUTER JOIN INTR_EMP EMP
			ON EMP.EMP_IDX = LINE.APRV_EMP_IDX
		LEFT OUTER JOIN INTR_DEPT DEPT
			ON DEPT.DEPT_CD = EMP.DEPT_CD
		LEFT OUTER JOIN INTR_GRADE GRDE
			ON GRDE.GRADE_CD = EMP.GRADE_CD
		WHERE LINE.APRV_IDX = #{contentIdx, jdbcType=VARCHAR}
		ORDER BY LINE.APRV_SNO
	</select>
</mapper>